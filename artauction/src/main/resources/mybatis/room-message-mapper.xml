<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="roomMessage">

	<select id="sequence" resultType="int">
		select room_message_seq.nextval from dual
	</select>
	
	<insert id="add">
		insert into room_message(
			room_message_no, room_message_type, room_message_sender, 
			room_message_receiver, room_message_content, room_message_time
		)
		values(
			#{roomMessageNo}, #{roomMessageType}, #{roomMessageSender}, 
			#{roomMessageReceiver, jdbcType=VARCHAR}, #{roomMessageContent}, 
			#{roomMessageTime}
		)
	</insert>
	
	<!-- 1:1 채팅 메시지 조회 -->
	<select id="listDirectMessage" resultType="WebsocketMessageVO">
		select 
			RM.room_message_no "no",
			RM.room_message_type "type",
			RM.room_message_sender "sender_member_id",
			M.member_level "sender_member_level",
			RM.room_message_receiver "receiver_member_id",
			RM.room_message_content "content",
			RM.room_message_time "time"
		from 
			room_message RM 
				left outer join member M 
					on RM.room_message_sender = M.member_id
		where 
			-- 1:1 채팅을 위한 발신자와 수신자 조건
			(
				RM.room_message_sender = #{senderId}
				and
				RM.room_message_receiver = #{receiverId}
			)
			or
			(
				RM.room_message_sender = #{receiverId}
				and
				RM.room_message_receiver = #{senderId}
			)
		order by RM.room_message_time asc
	</select>
</mapper>